<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WebAR 围棋 - 8th Wall</title>
  
  <!-- 8th Wall 引擎（替换 YOUR_APP_KEY） -->
  <script src="//cdn.8thwall.com/web/aframe/8frame-1.4.1.min.js"></script>
  <script src="//cdn.8thwall.com/web/xrextras/xrextras.js"></script>
  <script async src="//apps.8thwall.com/xrweb?appKey=XXXXXXXX"></script>
  
  <style>
    body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; background: #000; }
    
    #ui {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 10;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 40px 20px;
    }
    
    .top-info {
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 20px;
      text-align: center;
      font-size: 14px;
      align-self: center;
      backdrop-filter: blur(10px);
    }
    
    .bottom-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    
    .btn {
      background: #007AFF;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      pointer-events: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    
    .btn:active { transform: scale(0.95); }
    .btn-secondary { background: #34C759; }
    .btn:disabled { background: #666; opacity: 0.6; }
    
    #loading {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 18px;
      z-index: 20;
    }
  </style>
</head>
<body>

<div id="loading">正在启动相机...</div>

<div id="ui">
  <div class="top-info" id="statusText">移动手机扫描平面，点击放置棋盘</div>
  <div class="bottom-controls">
    <button id="placeBtn" class="btn" style="display:none">放置棋盘</button>
    <button id="resetBtn" class="btn btn-secondary" style="display:none">重新开始</button>
  </div>
</div>

<!-- 8th Wall AR 场景 -->
<a-scene 
  xrweb="allowedDevices: any"
  xrextras-almost-there
  xrextras-loading
  xrextras-runtime-error
  renderer="antialias: true; alpha: false; colorManagement: true"
  embedded>
  
  <a-assets>
    <a-asset-item id="stone-geo" src="https://cdn.jsdelivr.net/gh/aframevr/sample-assets@master/assets/models/sphere.gltf"></a-asset-item>
  </a-assets>

  <!-- 相机 -->
  <a-camera position="0 1.6 0" raycaster="objects: .clickable" cursor="rayOrigin: mouse"></a-camera>

  <!-- 灯光系统 -->
  <a-light type="ambient" intensity="0.5"></a-light>
  <a-light type="directional" intensity="0.8" position="0.5 1 0.5" cast-shadow="true"></a-light>

  <!-- 棋盘实体组（初始隐藏） -->
  <a-entity id="gameBoard" visible="false">
    <!-- 棋盘底座 -->
    <a-box id="boardBase" 
           position="0 0.01 0" 
           width="0.6" height="0.02" depth="0.6"
           material="color: #E6B800; roughness: 0.8"
           shadow="cast: true; receive: true">
    </a-box>
    
    <!-- 棋盘腿 -->
    <a-cylinder position="-0.25 -0.075 -0.25" radius="0.02" height="0.15" color="#8B4513" shadow="cast: true"></a-cylinder>
    <a-cylinder position="0.25 -0.075 -0.25" radius="0.02" height="0.15" color="#8B4513" shadow="cast: true"></a-cylinder>
    <a-cylinder position="-0.25 -0.075 0.25" radius="0.02" height="0.15" color="#8B4513" shadow="cast: true"></a-cylinder>
    <a-cylinder position="0.25 -0.075 0.25" radius="0.02" height="0.15" color="#8B4513" shadow="cast: true"></a-cylinder>
    
    <!-- 网格线（使用细长的 box 模拟） -->
    <a-entity id="gridLines"></a-entity>
    
    <!-- 棋子容器 -->
    <a-entity id="stonesGroup"></a-entity>
    
    <!-- 隐形点击平面（用于检测下棋位置） -->
    <a-plane id="clickPlane"
             position="0 0.03 0"
             rotation="-90 0 0"
             width="0.55" height="0.55"
             class="clickable"
             material="visible: false; transparent: true; opacity: 0">
    </a-plane>
  </a-entity>

  <!-- 放置指示器 -->
  <a-ring id="placementRing" 
          rotation="-90 0 0"
          radius-inner="0.1" 
          radius-outer="0.15"
          color="#007AFF"
          opacity="0.8"
          visible="false"
          animation="property: scale; to: 1.2 1.2 1.2; dir: alternate; dur: 1000; loop: true">
  </a-ring>

</a-scene>

<script>
  // 游戏状态
  let gameState = {
    boardPlaced: false,
    currentPlayer: 'black', // 'black' | 'white'
    stones: [], // {x, z, player, mesh}
    boardPos: null,
    boardRot: null
  };

  // 棋盘配置（19路）
  const BOARD_SIZE = 0.6; // 米
  const MARGIN = 0.05; // 边距
  const GRID_SIZE = BOARD_SIZE - (MARGIN * 2);
  const CELL_SIZE = GRID_SIZE / 18; // 18个间隔，19条线

  // 生成棋盘网格线
  function createGridLines() {
    const container = document.querySelector('#gridLines');
    const start = -GRID_SIZE / 2;
    
    // 横线
    for(let i=0; i<19; i++) {
      const z = start + i * CELL_SIZE;
      const line = document.createElement('a-box');
      line.setAttribute('position', `0 0.021 ${z}`);
      line.setAttribute('width', GRID_SIZE);
      line.setAttribute('height', '0.001');
      line.setAttribute('depth', '0.002');
      line.setAttribute('color', '#1a1a1a');
      container.appendChild(line);
    }
    
    // 竖线
    for(let i=0; i<19; i++) {
      const x = start + i * CELL_SIZE;
      const line = document.createElement('a-box');
      line.setAttribute('position', `${x} 0.021 0`);
      line.setAttribute('width', '0.002');
      line.setAttribute('height', '0.001');
      line.setAttribute('depth', GRID_SIZE);
      line.setAttribute('color', '#1a1a1a');
      container.appendChild(line);
    }
    
    // 星位（9个黑点）
    const stars = [3, 9, 15];
    stars.forEach(i => {
      stars.forEach(j => {
        const x = start + i * CELL_SIZE;
        const z = start + j * CELL_SIZE;
        const star = document.createElement('a-cylinder');
        star.setAttribute('position', `${x} 0.022 ${z}`);
        star.setAttribute('radius', '0.008');
        star.setAttribute('height', '0.001');
        star.setAttribute('color', '#1a1a1a');
        container.appendChild(star);
      });
    });
  }

  // 等待 8th Wall 就绪
  window.addEventListener('load', () => {
    createGridLines();
    
    const scene = document.querySelector('a-scene');
    
    scene.addEventListener('realityready', () => {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('placeBtn').style.display = 'block';
      console.log('8th Wall 已就绪');
    });
    
    scene.addEventListener('realityerror', (e) => {
      document.getElementById('loading').textContent = 'AR初始化失败: ' + e.detail;
    });
  });

  // 放置棋盘逻辑
  document.getElementById('placeBtn').addEventListener('click', () => {
    const ring = document.getElementById('placementRing');
    const board = document.getElementById('gameBoard');
    const camera = document.querySelector('a-camera');
    
    // 获取相机前方位置（1.5米处）
    const camPos = camera.getAttribute('position');
    const camRot = camera.getAttribute('rotation');
    const rad = (camRot.y * Math.PI) / 180;
    
    const x = camPos.x - Math.sin(rad) * 1.5;
    const z = camPos.z - Math.cos(rad) * 1.5;
    
    // 保存棋盘世界坐标
    gameState.boardPos = { x, y: 0, z };
    gameState.boardRot = camRot.y;
    
    // 放置棋盘
    board.setAttribute('position', `${x} 0 ${z}`);
    board.setAttribute('rotation', `0 ${camRot.y} 0`);
    board.setAttribute('visible', true);
    
    // 入场动画
    board.setAttribute('scale', '0 0 0');
    setTimeout(() => {
      board.setAttribute('animation', {
        property: 'scale',
        to: '1 1 1',
        dur: 600,
        easing: 'easeOutElastic'
      });
    }, 50);
    
    // 更新 UI
    gameState.boardPlaced = true;
    ring.setAttribute('visible', false);
    document.getElementById('placeBtn').style.display = 'none';
    document.getElementById('resetBtn').style.display = 'block';
    document.getElementById('statusText').textContent = '点击棋盘交叉点下棋（黑先）';
    
    // 添加点击监听
    setupBoardInteraction();
  });

  // 棋盘交互（下棋）
  function setupBoardInteraction() {
    const clickPlane = document.getElementById('clickPlane');
    
    clickPlane.addEventListener('click', (e) => {
      if(!gameState.boardPlaced) return;
      
      // 获取点击点在平面上的 UV 坐标
      const intersection = e.detail.intersection;
      if(!intersection) return;
      
      const point = intersection.point;
      
      // 转换为棋盘本地坐标（考虑棋盘旋转）
      const dx = point.x - gameState.boardPos.x;
      const dz = point.z - gameState.boardPos.z;
      const rot = (gameState.boardRot * Math.PI) / 180;
      
      // 逆向旋转
      const localX = dx * Math.cos(rot) - dz * Math.sin(rot);
      const localZ = dx * Math.sin(rot) + dz * Math.cos(rot);
      
      // 检查是否在有效范围内（-0.275 到 0.275）
      const halfSize = GRID_SIZE / 2;
      if(Math.abs(localX) > halfSize || Math.abs(localZ) > halfSize) return;
      
      // 吸附到最近的交叉点
      const gridX = Math.round((localX + halfSize) / CELL_SIZE);
      const gridZ = Math.round((localZ + halfSize) / CELL_SIZE);
      
      // 检查是否已有棋子
      const exists = gameState.stones.find(s => s.gx === gridX && s.gz === gridZ);
      if(exists) return;
      
      // 计算世界坐标放置棋子
      const stoneX = gameState.boardPos.x + 
        (gridX * CELL_SIZE - halfSize) * Math.cos(-rot) - 
        (gridZ * CELL_SIZE - halfSize) * Math.sin(-rot);
      const stoneZ = gameState.boardPos.z + 
        (gridX * CELL_SIZE - halfSize) * Math.sin(-rot) + 
        (gridZ * CELL_SIZE - halfSize) * Math.cos(-rot);
      
      placeStone(stoneX, stoneZ, gridX, gridZ);
    });
  }

  function placeStone(worldX, worldZ, gridX, gridZ) {
    const isBlack = gameState.currentPlayer === 'black';
    const stone = document.createElement('a-sphere');
    
    stone.setAttribute('position', `${worldX} ${gameState.boardPos.y + 0.04} ${worldZ}`);
    stone.setAttribute('radius', '0.018');
    stone.setAttribute('color', isBlack ? '#0d0d0d' : '#f5f5f5');
    stone.setAttribute('shadow', 'cast: true');
    
    // 高度动画（从上方落下）
    stone.setAttribute('animation', {
      property: 'position',
      from: `${worldX} ${gameState.boardPos.y + 0.2} ${worldZ}`,
      to: `${worldX} ${gameState.boardPos.y + 0.04} ${worldZ}`,
      dur: 300,
      easing: 'easeOutBounce'
    });
    
    document.getElementById('stonesGroup').appendChild(stone);
    
    // 保存状态
    gameState.stones.push({
      gx: gridX,
      gz: gridZ,
      player: gameState.currentPlayer,
      mesh: stone
    });
    
    // 切换玩家
    gameState.currentPlayer = isBlack ? 'white' : 'black';
    document.getElementById('statusText').textContent = 
      `第 ${gameState.stones.length} 手 - 当前：${gameState.currentPlayer === 'black' ? '黑方' : '白方'}`;
  }

  // 重置
  document.getElementById('resetBtn').addEventListener('click', () => {
    // 清除棋子
    const container = document.getElementById('stonesGroup');
    while(container.firstChild) {
      container.removeChild(container.firstChild);
    }
    gameState.stones = [];
    gameState.currentPlayer = 'black';
    
    // 隐藏棋盘
    document.getElementById('gameBoard').setAttribute('visible', false);
    gameState.boardPlaced = false;
    
    document.getElementById('resetBtn').style.display = 'none';
    document.getElementById('placeBtn').style.display = 'block';
    document.getElementById('statusText').textContent = '移动手机，点击按钮放置棋盘';
  });
</script>

</body>
</html>
