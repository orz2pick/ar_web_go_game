<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR 围棋 - 适配版</title>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #000;
            touch-action: none;
        }
        
        #video-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            opacity: 0.6;
            transform: scaleX(-1);
            display: none;
        }
        
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        
        .info-box {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 15px;
            text-align: center;
            max-width: 90%;
            backdrop-filter: blur(10px);
            line-height: 1.4;
        }
        
        .error-box {
            background: rgba(255, 59, 48, 0.9);
        }
        
        .button {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #007AFF;
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 17px;
            border-radius: 12px;
            cursor: pointer;
            pointer-events: auto;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        
        #startBtn { top: 45%; }
        #fallbackBtn { 
            top: 55%; 
            background: #5856D6;
            display: none;
        }
        
        #manualControls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 10px;
            pointer-events: auto;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 30px;
        }
        
        .ctrl-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            font-size: 20px;
            cursor: pointer;
            margin: 0 5px;
        }
        
        #confirmPlacement {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #34C759;
            display: none;
            pointer-events: auto;
        }
        
        #finger-cursor {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid #007AFF;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 20;
            pointer-events: none;
        }
        
        #progress-ring {
            position: absolute;
            width: 50px;
            height: 50px;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 21;
            pointer-events: none;
        }
        
        .progress-circle {
            fill: none;
            stroke: #34C759;
            stroke-width: 4;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            stroke-dasharray: 126;
            stroke-dashoffset: 126;
            transition: stroke-dashoffset 0.1s linear;
        }
        
        .mode-tag {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(0,0,0,0.6);
            color: #FFD700;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <video id="video-bg" playsinline muted></video>
    <div id="canvas-container"></div>
    
    <div id="ui">
        <div id="info" class="info-box">正在检查设备兼容性...</div>
        <button id="startBtn" class="button">启动 AR 体验</button>
        <button id="fallbackBtn" class="button">使用手动模式（无需AR）</button>
        
        <div id="manualControls">
            <button class="ctrl-btn" onclick="adjustBoard('up')">↑</button>
            <button class="ctrl-btn" onclick="adjustBoard('down')">↓</button>
            <button class="ctrl-btn" onclick="adjustBoard('rotate')">↻</button>
            <button class="ctrl-btn" onclick="adjustBoard('scale+')">+</button>
            <button class="ctrl-btn" onclick="adjustBoard('scale-')">−</button>
        </div>
        
        <button id="confirmPlacement" class="button">确认位置，开始下棋</button>
        
        <div id="finger-cursor"></div>
        <svg id="progress-ring" viewBox="0 0 44 44">
            <circle class="progress-circle" cx="22" cy="22" r="20"></circle>
        </svg>
        
        <div id="modeTag" class="mode-tag" style="display:none"></div>
    </div>

<script>
    // ==================== 配置 ====================
    const CONFIG = {
        gridCount: 19,
        boardSize: 0.6, // 米（AR模式）或相对大小（手动模式）
        hoverTime: 3000,
        colors: { black: 0x1a1a1a, white: 0xf0f0f0, board: 0xE6B800 }
    };
    
    // ==================== 状态 ====================
    let state = {
        mode: 'checking', // 'checking', 'webxr', 'fallback', 'manual'
        boardPlaced: false,
        currentPlayer: 'black',
        stones: [],
        isHovering: false,
        hoverStart: 0,
        boardTransform: { x: 0, y: -0.5, z: -1, rot: 0, scale: 1 }
    };
    
    let camera, scene, renderer;
    let xrSession = null, hitTestSource = null, reticle;
    let goBoard, boardGroup;
    let hands, cameraUtils;
    let videoElement;
    
    // ==================== 初始化检测 ====================
    function checkCompatibility() {
        const info = document.getElementById('info');
        const isHTTPS = location.protocol === 'https:';
        const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        
        // iOS WebXR 需要 HTTPS（localhost除外）
        if (!isHTTPS && !isLocalhost) {
            info.innerHTML = '⚠️ 请使用 HTTPS 访问<br><small>GitHub Pages 链接自动支持，检查地址栏是否为 https://</small>';
            info.className = 'info-box error-box';
            return;
        }
        
        if (!navigator.xr) {
            info.innerHTML = '检测到 iOS 设备，但 WebXR 未启用<br><small>将使用视频透视模式（效果同样出色）</small>';
            document.getElementById('fallbackBtn').style.display = 'block';
        } else {
            info.textContent = '设备支持 AR，点击启动';
        }
    }
    
    // ==================== Three.js 初始化 ====================
    function initScene() {
        const container = document.getElementById('canvas-container');
        
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
        
        // 灯光
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(0.5, 1, 0.5);
        light.castShadow = true;
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        
        // 渲染器
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.xr.enabled = true;
        container.appendChild(renderer.domElement);
        
        // 创建棋盘
        createGoBoard();
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    }
    
    function createGoBoard() {
        boardGroup = new THREE.Group();
        
        // 棋盘纹理
        const canvas = document.createElement('canvas');
        canvas.width = 1024; canvas.height = 1024;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#E6B800'; ctx.fillRect(0,0,1024,1024);
        
        // 木纹
        ctx.strokeStyle = '#D4A000';
        for(let i=0; i<1024; i+=20) {
            ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(1024,i); ctx.stroke();
        }
        
        // 边框和网格
        ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 24;
        ctx.strokeRect(48,48,928,928);
        ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 3;
        const margin=90, size=844, step=size/(CONFIG.gridCount-1);
        
        for(let i=0; i<CONFIG.gridCount; i++) {
            const pos = margin + i*step;
            ctx.beginPath(); ctx.moveTo(margin,pos); ctx.lineTo(margin+size,pos); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(pos,margin); ctx.lineTo(pos,margin+size); ctx.stroke();
        }
        
        // 星位
        ctx.fillStyle = '#1a1a1a';
        [3,9,15].forEach(x => {
            [3,9,15].forEach(y => {
                ctx.beginPath();
                ctx.arc(margin+x*step, margin+y*step, 10, 0, Math.PI*2);
                ctx.fill();
            });
        });
        
        const texture = new THREE.CanvasTexture(canvas);
        const geometry = new THREE.BoxGeometry(1, 0.02, 1);
        const material = new THREE.MeshStandardMaterial({ map: texture, roughness: 0.7 });
        const board = new THREE.Mesh(geometry, material);
        board.receiveShadow = true;
        boardGroup.add(board);
        
        // 棋盘腿
        const legGeo = new THREE.CylinderGeometry(0.03, 0.02, 0.15, 16);
        const legMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
        [[-0.4,-0.075,-0.4], [0.4,-0.075,-0.4], [-0.4,-0.075,0.4], [0.4,-0.075,0.4]].forEach(pos => {
            const leg = new THREE.Mesh(legGeo, legMat);
            leg.position.set(...pos);
            leg.castShadow = true;
            boardGroup.add(leg);
        });
        
        scene.add(boardGroup);
        updateBoardTransform();
    }
    
    function updateBoardTransform() {
        if (!boardGroup) return;
        boardGroup.position.set(state.boardTransform.x, state.boardTransform.y, state.boardTransform.z);
        boardGroup.rotation.y = state.boardTransform.rot;
        boardGroup.scale.setScalar(state.boardTransform.scale);
    }
    
    // ==================== WebXR 模式 ====================
    async function startWebXR() {
        try {
            const supported = await navigator.xr.isSessionSupported('immersive-ar');
            if (!supported) throw new Error('AR not supported');
            
            xrSession = await navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'],
                domOverlay: { root: document.body }
            });
            
            await renderer.xr.setSession(xrSession);
            renderer.xr.setReferenceSpaceType('local');
            
            state.mode = 'webxr';
            setupWebXR();
            
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('info').textContent = '移动手机寻找桌面，点击屏幕放置';
            
        } catch(e) {
            console.error('WebXR failed:', e);
            startFallbackMode();
        }
    }
    
    function setupWebXR() {
        // 创建瞄准器
        const ring = new THREE.RingGeometry(0.1, 0.15, 32);
        const mat = new THREE.MeshBasicMaterial({ color: 0x007AFF, transparent: true, opacity: 0.6, side: THREE.DoubleSide });
        reticle = new THREE.Mesh(ring, mat);
        reticle.rotation.x = -Math.PI/2;
        reticle.visible = false;
        scene.add(reticle);
        
        xrSession.requestReferenceSpace('viewer').then(space => {
            xrSession.requestHitTestSource({ space }).then(source => {
                hitTestSource = source;
            });
        });
        
        xrSession.addEventListener('select', onXRSelect);
        renderer.setAnimationLoop(onXRFrame);
    }
    
    function onXRFrame(time, frame) {
        if (frame && hitTestSource) {
            const refSpace = renderer.xr.getReferenceSpace();
            const results = frame.getHitTestResults(hitTestSource);
            
            if (results.length > 0) {
                const pose = results[0].getPose(refSpace);
                reticle.visible = true;
                reticle.matrix.fromArray(pose.transform.matrix);
            } else {
                reticle.visible = false;
            }
        }
        renderer.render(scene, camera);
    }
    
    function onXRSelect() {
        if (reticle.visible && !state.boardPlaced) {
            boardGroup.position.setFromMatrixPosition(reticle.matrix);
            boardGroup.quaternion.setFromRotationMatrix(reticle.matrix);
            state.boardPlaced = true;
            reticle.visible = false;
            
            document.getElementById('info').textContent = '棋盘已放置，启动手部追踪...';
            setTimeout(startHandTracking, 500);
        }
    }
    
    // ==================== 降级/手动模式 ====================
    function startFallbackMode() {
        state.mode = 'fallback';
        videoElement = document.getElementById('video-bg');
        videoElement.style.display = 'block';
        
        // 请求摄像头
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' }, 
            audio: false 
        }).then(stream => {
            videoElement.srcObject = stream;
            videoElement.play();
            
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('fallbackBtn').style.display = 'none';
            document.getElementById('manualControls').style.display = 'flex';
            document.getElementById('confirmPlacement').style.display = 'block';
            document.getElementById('info').innerHTML = '手动调整棋盘位置<br>使用下方按钮对齐到桌面';
            document.getElementById('modeTag').textContent = '手动模式';
            document.getElementById('modeTag').style.display = 'block';
            
            // 设置初始位置
            state.boardTransform = { x: 0, y: -0.3, z: -0.8, rot: 0, scale: 0.5 };
            updateBoardTransform();
            
            renderer.setAnimationLoop(() => renderer.render(scene, camera));
        }).catch(err => {
            document.getElementById('info').innerHTML = '无法访问摄像头<br>请检查权限设置';
        });
    }
    
    function adjustBoard(type) {
        switch(type) {
            case 'up': state.boardTransform.y += 0.05; break;
            case 'down': state.boardTransform.y -= 0.05; break;
            case 'rotate': state.boardTransform.rot += Math.PI/8; break;
            case 'scale+': state.boardTransform.scale *= 1.1; break;
            case 'scale-': state.boardTransform.scale *= 0.9; break;
        }
        updateBoardTransform();
    }
    
    document.getElementById('confirmPlacement').addEventListener('click', () => {
        state.boardPlaced = true;
        document.getElementById('manualControls').style.display = 'none';
        document.getElementById('confirmPlacement').style.display = 'none';
        startHandTracking();
    });
    
    // ==================== 手部追踪（通用） ====================
    function startHandTracking() {
        document.getElementById('info').textContent = '伸出食指，悬停3秒落子（黑先）';
        
        hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });
        
        hands.onResults(onHandResults);
        
        // 使用前置摄像头（镜像）或后置
        cameraUtils = new Camera(document.createElement('video'), {
            onFrame: async () => {
                await hands.send({image: cameraUtils.video});
            },
            width: 1280,
            height: 720
        });
        
        cameraUtils.start();
    }
    
    function onHandResults(results) {
        const cursor = document.getElementById('finger-cursor');
        const ring = document.getElementById('progress-ring');
        
        if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
            cursor.style.display = 'none';
            ring.style.display = 'none';
            state.isHovering = false;
            return;
        }
        
        const tip = results.multiHandLandmarks[0][8]; // 食指尖
        const x = (1 - tip.x) * window.innerWidth;
        const y = tip.y * window.innerHeight;
        
        cursor.style.display = 'block';
        cursor.style.left = x + 'px';
        cursor.style.top = y + 'px';
        
        // 射线检测
        const mouse = new THREE.Vector2();
        mouse.x = (x / window.innerWidth) * 2 - 1;
        mouse.y = -(y / window.innerHeight) * 2 + 1;
        
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        
        // 与棋盘平面相交
        const boardY = boardGroup.position.y + 0.01;
        const distance = (boardY - raycaster.ray.origin.y) / raycaster.ray.direction.y;
        
        if (distance > 0) {
            const point = new THREE.Vector3();
            raycaster.ray.at(distance, point);
            
            // 转换为棋盘本地坐标
            const localX = point.x - boardGroup.position.x;
            const localZ = point.z - boardGroup.position.z;
            const half = 0.5 * boardGroup.scale.x;
            
            if (Math.abs(localX) <= half && Math.abs(localZ) <= half) {
                const step = (half * 2) / (CONFIG.gridCount - 1);
                const gx = Math.round((localX + half) / step);
                const gz = Math.round((localZ + half) / step);
                
                // 检查是否已有子
                const exists = state.stones.find(s => s.gx === gx && s.gz === gz);
                if (!exists) {
                    handleHover(gx, gz, x, y);
                    return;
                }
            }
        }
        
        resetHover();
    }
    
    function handleHover(gx, gz, screenX, screenY) {
        const ring = document.getElementById('progress-ring');
        
        if (!state.isHovering || state.hoverGrid?.gx !== gx || state.hoverGrid?.gz !== gz) {
            state.isHovering = true;
            state.hoverGrid = { gx, gz };
            state.hoverStart = Date.now();
            
            ring.style.display = 'block';
            ring.style.left = screenX + 'px';
            ring.style.top = screenY + 'px';
        }
        
        const elapsed = Date.now() - state.hoverStart;
        const progress = Math.min(elapsed / CONFIG.hoverTime, 1);
        document.querySelector('.progress-circle').style.strokeDashoffset = 126 - (progress * 126);
        
        if (progress >= 1) {
            placeStone(gx, gz);
            resetHover();
        }
    }
    
    function resetHover() {
        state.isHovering = false;
        state.hoverGrid = null;
        document.getElementById('progress-ring').style.display = 'none';
    }
    
    function placeStone(gx, gz) {
        const geometry = new THREE.SphereGeometry(0.04, 32, 32);
        const material = new THREE.MeshStandardMaterial({
            color: state.currentPlayer === 'black' ? CONFIG.colors.black : CONFIG.colors.white,
            roughness: 0.2
        });
        
        const stone = new THREE.Mesh(geometry, material);
        const half = 0.5 * boardGroup.scale.x;
        const step = (half * 2) / (CONFIG.gridCount - 1);
        
        stone.position.x = boardGroup.position.x - half + gx * step;
        stone.position.z = boardGroup.position.z - half + gz * step;
        stone.position.y = boardGroup.position.y + 0.03;
        
        stone.scale.set(0,0,0);
        boardGroup.add(stone);
        
        // 动画
        let s = 0;
        const anim = setInterval(() => {
            s += 0.2;
            stone.scale.set(s,s,s);
            if (s >= 1) clearInterval(anim);
        }, 16);
        
        state.stones.push({ gx, gz, mesh: stone });
        state.currentPlayer = state.currentPlayer === 'black' ? 'white' : 'black';
        
        const text = state.currentPlayer === 'black' ? '黑方' : '白方';
        document.getElementById('info').textContent = `第 ${state.stones.length} 手 - 当前：${text}`;
    }
    
    // ==================== 事件绑定 ====================
    window.onload = () => {
        initScene();
        checkCompatibility();
    };
    
    document.getElementById('startBtn').addEventListener('click', () => {
        if (navigator.xr) startWebXR();
        else startFallbackMode();
    });
    
    document.getElementById('fallbackBtn').addEventListener('click', startFallbackMode);
    
    // 阻止默认触摸行为
    document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
</script>

</body>
</html>
